<?xml version="1.0" encoding="UTF-8"?>
<proxy name="telflowGetOfferingsProxy" startOnLoad="true" statistics="enable" trace="enable" transports="http https" xmlns="http://ws.apache.org/ns/synapse">
    <target>
        <inSequence>
            <propertyGroup>
                <property expression="$url:offeringId" name="offeringId" scope="default" type="STRING"/>
                <property expression="$url:accessToken" name="accessToken" scope="default" type="STRING"/>
            </propertyGroup>
            <filter regex="false" source="boolean($ctx:offeringId)">
                <then>
                    <payloadFactory description="Invalid Request" media-type="json">
                        <format>{
"errorCode" : "400",
"errorMessage": "offeringId is required"
}
</format>
                        <args/>
                    </payloadFactory>
                    <log description="AUDIT_ERROR" level="custom" separator=",">
                        <property expression="json-eval($)" name="AUDIT_ERROR"/>
                    </log>
                    <property name="HTTP_SC" scope="axis2" type="STRING" value="400"/>
                    <respond/>
                </then>
                <else/>
            </filter>
            <filter description="check if access token passed as a parameter in the url" regex="false" source="boolean($ctx:accessToken)">
                <then>
                    <log description="AUDIT_TEMP_EXIT" level="custom" separator=",">
                        <property name="AUDIT_TEMP_EXIT" value="***INVOKING TELFLOW AUTHORIZATION TOKEN***"/>
                    </log>
                    <property expression="get-property('file', 'TELFLOW_AUTHORIZATION_TOKEN_PROXY_EP')" name="uri.var.telflowAuthorizationTokenProxyEP" scope="default" type="STRING"/>
                    <call>
                        <endpoint>
                            <http method="get" statistics="enable" trace="enable" uri-template="{uri.var.telflowAuthorizationTokenProxyEP}">
                                <suspendOnFailure>
                                    <errorCodes>-1</errorCodes>
                                    <initialDuration>-1</initialDuration>
                                    <progressionFactor>-1</progressionFactor>
                                    <maximumDuration>0</maximumDuration>
                                </suspendOnFailure>
                                <markForSuspension>
                                    <errorCodes>-1</errorCodes>
                                    <retriesBeforeSuspension>0</retriesBeforeSuspension>
                                </markForSuspension>
                            </http>
                        </endpoint>
                    </call>
                    <log description="AUDIT_REENTRY" level="custom" separator=",">
                        <property name="AUDIT_REENTRY" value="***TELFLOW AUTHORIZATION TOKEN COMPLETED***"/>
                    </log>
                    <property expression="json-eval($.access_token)" name="accessToken" scope="default" type="STRING"/>
                </then>
                <else/>
            </filter>
            <propertyGroup>
                <property name="messageType" scope="axis2" type="STRING" value="application/json"/>
                <property expression="get-property('file', 'TELFLOW_OFFERINGS_EP')" name="telfowOfferingsEP" scope="default" type="STRING"/>
                <property expression="fn:concat('Bearer ',get-property('accessToken'))" name="Authorization" scope="transport" type="STRING"/>
                <property expression="fn:concat($ctx:telfowOfferingsEP,'/', $ctx:offeringId)" name="uri.var.telflow_get_offerings_url" scope="default" type="STRING"/>
            </propertyGroup>
            <call>
                <endpoint key="telflowOfferingsEndPoint"/>
            </call>
            <log description="AUDIT_EXIT" level="full" separator=",">
                <property expression="json-eval($)" name="AUDIT_EXIT"/>
            </log>
            <respond/>
        </inSequence>
        <outSequence/>
        <faultSequence/>
    </target>
</proxy>
